#!/bin/bash

script_path=$(dirname "$0")

set -eEo pipefail
trap '$script_path/_stacktrace.sh "$?" "$BASH_SOURCE" "$BASH_COMMAND" "$LINENO"' ERR

scan=$1
scan_input=$2
scan_args=$3

result=/tmp/adh-exploit-and-save-result.txt
$script_path/exploit.sh "$scan" "$scan_input" "$scan_args" > $result

# Save vulns on database if output is not empty
if [ -s "$result" ]; then
	$script_path/query_dgraph.sh -q "
		mutation {
			addVuln(input: $(jq -c -s $result), upsert: true){
				vuln { name }
			}
		}
	"
fi
