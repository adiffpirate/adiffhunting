#!/bin/bash
set -eEo pipefail
trap 'echo "ERROR: Command failed"; exit 1' ERR

nuclei_scan(){
	nuclei_input=$1
	nuclei_output=$2
	nuclei_args=$3

	# Get updated list of resolvers once a day
	resolvers=/tmp/resolvers.txt
	if [ $(($(date +%s)-$(date +%s -r $resolvers || echo 86401))) -gt 86400 ]; then
		>&2 echo "Downloading resolvers file"
		curl --no-progress-meter --fail https://raw.githubusercontent.com/trickest/resolvers/main/resolvers.txt > $resolvers
	fi

	nuclei \
		-list $nuclei_input -output $nuclei_output -jsonl \
		-silent -no-stdin -resolvers $resolvers \
		-concurrency 1 -rate-limit 10 \
		$nuclei_args

	if [ ! -s "$nuclei_output" ]; then
		echo "Nothing was found"
	fi
}

dangling_cname_scan(){
	input=$1
	output=$2

	# Scan with nuclei
	unrefined_output=/tmp/adh-dangling_cname_scan-unrefined_output
	nuclei_scan $input $unrefined_output '-t dns/detect-dangling-cname.yaml'

	# Get unique list of domains from dangling cnames findings
	domains=/tmp/adh-dangling_cname_scan-domains
	echo '' > $domains
	cat $unrefined_output | while read line; do
		cname=$(echo $line | jq -r '."extracted-results"[0]' | sed 's/\.$//')
		# Get rootdomain by leveraging the tld list file
		echo $cname | egrep -o "[^.]+\.($(xargs -a $UTILS/tld-list.txt | sed 's/ /|/g'))(\.[^.]+)?$" >> $domains
	done
	sort -u $domains -o $domains

	if [[ "$DEBUG" == "true" ]]; then
		echo "Will check the following rootdomains availability:"
		cat $domains
	fi

	# For each domain
	cat $domains | while read domain; do
		# Check if is available to claim
		echo -n "Checking if $domain is available: "
		if whois $domain 2>/dev/null | grep -i 'no match\|not found' > /dev/null; then
			echo "YES"
			# Add to output all dangling cname findings from nuclei with this domain
			jq -c "select(.\"extracted-results\"[0] | test(\"$domain(.)?$\"))" $unrefined_output 2>/dev/null >> $output
		else
			echo "NO"
		fi
	done
}

scan_and_save(){
	scan=$1
	input=$2
	args=$3

	# Scan
	output=/tmp/adh-scan_and_save-output
	$scan "$input" "$output" "$args"

	# Save vulns on database
	if [ -s "$output" ]; then
		query_file=/tmp/adh-scan_and_save-query_file
		echo "
			mutation {
				addVuln(input: $(cat $output | parse_output | jq -s), upsert: true){
					vuln { name }
				}
			}
		" > $query_file
		$UTILS/query_dgraph.sh -f $query_file | jq -c .
	fi
}

# Print output in JSON Lines format
parse_output(){
	while read line; do
		echo $line | jq -c '{
			name: ( .info.name + ": " + ."matched-at" ),
			domain: { name: ."matched-at" },
			title: .info.name,
			class: { name: "subdomain takeover" },
			description: .info.description,
			severity: .info.severity,
			references: .info.reference,
			evidence: { target: ."extracted-results"[0], request: .request, response: .response },
			foundBy: [ { name: "nuclei", type: "exploit" } ],
			updatedAt: .timestamp
		}' || >&2 echo "Error while processing: $line"
	done
}

get_domains(){
	filter='not eq(Domain.skipScans, true)'
	extra_filter=$1
	if [ -n "$extra_filter" ]; then
		filter="$filter and $extra_filter"
	fi

	records=/tmp/adh-get_domains-records.txt
	# Get CNAME values from 100 domains without the "lastExploit" field
	$UTILS/get_dnsrecords.sh -t CNAME -f "$filter and not has(Domain.lastExploit)" -a 'first: 100' > $records
	# If all domains have "lastExploit", get 100 oldests that are at least older than $DOMAIN_SCAN_COOLDOWN
	if [ ! -s "$records" ]; then
		$UTILS/get_dnsrecords.sh -t CNAME \
			-f "$filter and lt(Domain.lastExploit, \"$(date -Iseconds -d "-$DOMAIN_SCAN_COOLDOWN")\")" \
			-a 'first: 100, orderasc: Domain.lastExploit' \
		> $records
	fi

	if [ ! -s "$records" ]; then # Return if unable to get records
		return
	fi

	if [[ $DEBUG == "true" ]]; then
		>&2 echo "Will scan the following records:"
		>&2 cat $records
	fi

	# Get domains from cname records
	domains=/tmp/adh-get_domains-domains
	cat $records | awk '{print $1}' $records | sort -u > $domains

	>&2 echo "Updating lastExploit field"
	>&2 $UTILS/save_domains.sh -f <(cat $domains | sed '1i name,lastExploit' | sed "s/$/,$(date -Iseconds)/")

	# Print domains
	cat $domains
}

while true; do

	$UTILS/wait_for_db.sh

	domains=/tmp/adh-domains
	get_domains > $domains

	if [ ! -s "$domains" ]; then
		echo "No domains to scan. Trying again in 10 seconds"
		sleep 10
		continue
	fi

	echo "Starting Scan: Dangling CNAME - Generic"
	scan_and_save 'dangling_cname_scan' $domains

	echo "Starting Scan: Dangling CNAME - Cloud Providers"
	scan_and_save 'nuclei_scan' $domains '-templates dns/elasticbeanstalk-takeover.yaml,dns/azure-takeover-detection.yaml'

	echo "Starting Scan: HTTP Based Takeovers"
	scan_and_save 'nuclei_scan' $domains '-templates http/takeovers'

done
